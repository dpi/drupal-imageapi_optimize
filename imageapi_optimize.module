<?php
/**
 * @file
 * Image optimize functionalities
 */

/**
 * Implements hook_hook_info().
 */
function imageapi_optimize_hook_info() {
  $hooks = array();

  $hooks['imageapi_optimize_info'] = array(
    'group' => 'imageapi_optimize',
  );

  $hooks['imageapi_optimize_processors'] = array(
    'group' => 'imageapi_optimize',
  );

  return $hooks;
}

/**
 * Implements hook_theme().
 */
function imageapi_optimize_theme() {
  $items = array();

  $items['imageapi_optimize_services_internal_form'] = array(
    'render element' => 'form',
    'file' => 'services/internal.inc',
  );

  return $items;
}

/**
 * Implements hook_menu().
 */
function imageapi_optimize_menu() {

  $items['admin/config/media/imageapi-optimize'] = array(
    'title' => 'ImageAPI Optimize',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('imageapi_optimize_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'imageapi_optimize.admin.inc',
  );

  $items['admin/config/media/imageapi-optimize/%'] = array(
    'title callback' => 'imageapi_optimize_internal_binary_settings_title',
    'title arguments' => array(4),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('imageapi_optimize_internal_binary_settings', 4),
    'access arguments' => array('administer site configuration'),
    'file' => 'services/internal.inc',
  );

  return $items;
}

/**
 * Implements image_HOOK_save().
 */
function image_imageapi_optimize_save(stdClass $image, $dst) {
  if (_imageapi_optimize_invoke('save', $image, array($dst))) {
    $return = _imageapi_optimize_optimize($image, $dst);
  }
  else {
    $return = FALSE;
  }

  // Remove our magic.
  $image->toolkit = $toolkit = isset($image->original_toolkit) ? $image->original_toolkit : variable_get('imageapi_optimize_toolkit', '');
  unset($image->original_toolkit);

  return $return;
}

/**
 * Helper. Based on image_toolkit_invoke().
 *
 * @see imageapi_optimize_optimize_effect
 */
function _imageapi_optimize_invoke($method, $image, array $params = array()) {
  $toolkit = isset($image->original_toolkit) ? $image->original_toolkit : variable_get('imageapi_optimize_toolkit', '');
  $function = 'image_' . $toolkit . '_' . $method;
  if (function_exists($function)) {
    array_unshift($params, $image);
    return call_user_func_array($function, $params);
  }
  return FALSE;
}

/**
 * Optimizes image with external commands
 */
function _imageapi_optimize_optimize($image, $dst) {
  $info = imageapi_optimize_info();
  $service = isset($image->imageapi_optimize['service']) ? $image->imageapi_optimize['service'] : variable_get('imageapi_optimize_service', 'internal');

  if (isset($info['services'][$service])) {
    $service = $info['services'][$service];
    if (isset($service['file'])) {
      include_once $service['file'];
    }

    $settings = isset($image->imageapi_optimize['settings']) ? $image->imageapi_optimize['settings'] : array();

    $service['callbacks']['process']($image, $dst, $settings);
  }

  // If optimize service fails, there is no problem. Original image is saved.
  return TRUE;
}

/**
 * Load all defined services and binaries info definitions.
 */
function imageapi_optimize_info($reset = FALSE) {
  $cache = cache_get('imageapi_optimize:info');

  if (!$cache || $reset) {
    $info = module_invoke_all('imageapi_optimize_info');
    drupal_alter('imageapi_optimize_info', $info);

    // Process and validate all defined info.
    foreach ($info as $type => &$types) {
      foreach ($types as $name => &$data) {
        // Set defaults.
        $data += array(
          'callbacks' => array(),
          'weight' => 0,
        );
        $data['callbacks'] += array(
          'process' => 'imageapi_optimize_' . $type . '_' . $name,
        );

        // Add form callback if undefined yet available.
        if (!isset($data['callbacks']['form'])) {
          $function = 'imageapi_optimize_' . $type . '_' . $name . '_form';
          if (function_exists($function)) {
            $data['callbacks']['form'] = $function;
          }
        }

        // Set user defined binaries weight if available.
        if ('binaries' == $type) {
          $settings = variable_get('imageapi_optimize_' . $name, array());
          $data['weight'] = isset($settings['weight']) ? $settings['weight'] : $data['weight'];

          if (empty($data['settings'])) {
            $data['settings'] = array();
          }
        }

        // Validate info.
        $error = '';
        if (!isset($data['title'])) {
          $error .= t('Title not set.') . '<br />';
        }

        foreach ($data['callbacks'] as $callback) {
          if (!function_exists($callback)) {
            $error .= t('Function !callback doesn\'t exist.', array('!callback' => $callback)) . '<br />';
          }
        }

        if (isset($data['file']) && !file_exists($data['file'])) {
          $error .= t('File !file doesn\'t exist.', array('!file' => $data['file'])) . '<br />';
        }

        if (!empty($error)) {
          unset($info[$type][$name]);
          watchdog('imageapi_optimize', $error);
        }
      }

      // Sort by weight.
      uasort($info[$type], 'drupal_sort_weight');
    }

    // Cache the info to reduce future load times.
    cache_set('imageapi_optimize:info', $info);
    return $info;
  }

  return $cache->data;
}

/**
 * Implements hook_image_effect_info().
 */
function imageapi_optimize_image_effect_info() {
  $effects = array();

  $effects['imageapi_optimize'] = array(
    'label' => t('ImageAPI Optimize'),
    'help' => t('This will optmize the image using the selected options, this should be the last effect in the preset'),
    'effect callback' => 'imageapi_optimize_optimize_effect',
    'form callback' => 'imageapi_optimize_optimize_effect_form',
    //'summary theme' => 'imageapi_optimize_optimize_effect_summary',
  );

  return $effects;
}

/**
 * Image effect callback for image optimize.
 *
 * We actually just change the image toolkit to 'imageapi_optimize' so that
 * when image_toolkit_invoke() is called by image_style_create_derivative()
 * our function image_imageapi_optimize_save() is called.
 */
function imageapi_optimize_optimize_effect(stdClass $image, $options) {
  $image->original_toolkit = $image->toolkit;
  $image->toolkit = 'imageapi_optimize';

  // Process the settings so that they're available later.
  if (isset($options['setting_source']) && $options['setting_source'] == 'style') {
    // Settings come from this image style.
  }
  else {
    // Settings come from the global settings.
    $image->imageapi_optimize['service'] = variable_get('imageapi_optimize_service', 'internal');
    $image->imageapi_optimize['settings'] = variable_get('imageapi_optimize_' . $image->imageapi_optimize['service'], array());
  }
}

function imageapi_optimize_optimize_effect_form($data) {
  $form = array();

  $form['setting_source'] = array(
    '#type' => 'radios',
    '#title' => t('Settings'),
    '#options' => array(
      'global' => t('Use global settings'),
      'style' => t('Style specific settings'),
    ),
    '#default_value' => isset($data['setting_source']) ? $data['setting_source'] : 'global',
  );



  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function imageapi_optimize_form_image_style_form_alter(&$form, &$form_state, $form_id) {
  $form['#validate'][] = 'imageapi_optimize_form_image_style_validate';
  $form['effects']['new']['add']['#validate'][] = 'imageapi_optimize_form_image_style_validate';

  // We only allow our effect to be added to a style once.
  $style = $form_state['image_style'];
  foreach ($style['effects'] as $effect) {
    if ($effect['name'] == 'imageapi_optimize') {
      unset($form['effects']['new']['new']['#options']['imageapi_optimize']);
    }
  }
}

/**
 * Form validation function for image_style_form().
 *
 * We ensure that if our effect is present in the form it has the highest
 * weight.
 */
function imageapi_optimize_form_image_style_validate($form, &$form_state) {
  // Update the image style.
  $style = $form_state['image_style'];

  // Find the max of all the 'other' weights.
  $weights = array();
  $imageapi_optimize_effects_id = NULL;
  if (!empty($form_state['values']['effects'])) {
    foreach ($form_state['values']['effects'] as $ieid => $effect_data) {
      if (isset($style['effects'][$ieid])) {
        $effect = $style['effects'][$ieid];
        if ($effect['name'] == 'imageapi_optimize') {
          $imageapi_optimize_effects_id = $ieid;
        }
        else {
          $weights[] = $effect_data['weight'];
        }
      }
    }
  }

  // If the user is adding an effect, consider that too.
  if ($form_state['triggering_element']['#value'] == $form['effects']['new']['add']['#value']) {
    $weights[] = $form_state['values']['weight'];
  }

  if (isset($imageapi_optimize_effects_id) && !empty($weights)) {
    form_set_value($form['effects'][$imageapi_optimize_effects_id]['weight'], max($weights) + 1, $form_state);
  }
}

/**
 * Implements hook_ctools_plugin_type().
 */
function imageapi_optimize_ctools_plugin_type() {
  return array(
    'processors' => array(
      'use hooks' => TRUE,
    ),
  );
}

function imageapi_optimize_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && $plugin == 'export_ui') {
    return 'plugins/' . $plugin;
  }
}

function imageapi_optimize_get_processor($id) {
  ctools_include('plugins');
  if ($class = ctools_plugin_load_class('imageapi_optimize', 'processors', $id, 'handler')) {
    return new $class();
  }
}

function imageapi_optmize_list_of_processors() {
  $options = array();

  ctools_include('plugins');
  $processors = ctools_get_plugins('imageapi_optimize', 'processors');
  if (is_array($processors)) {
    foreach ($processors as $processor) {
      $options[$processor['name']] = $processor['label'];
    }
  }

  return $options;

}

function example_ctools_export_ui_form(&$form, &$form_state) {
  // This needs to:

  // 1. Provide a nice UI for adding a new processor to this pipeline.
  $form['add_new_processor'] = array(
    '#type' => 'fieldset',
    '#title' => t('Add new processor'),
  );

  $form['add_new_processor']['new_processor_select'] = array(
    '#type' => 'select',
    '#options' => imageapi_optmize_list_of_processors(),
  );

  $form['add_new_processor']['new_processor_add'] = array(
    '#type' => 'submit',
    '#value' => t('Add new processor'),
    '#submit' => array(
      'imageapi_optimize_pipeline_edit_add_new_processor_submit',
    ),
  );



  // 2. Provide a machanism for removing a processor from the pipeline.
  // 3. Provice a way to configure each processor in the pipeline.
  // 4. Provide a way to re-order the processors.
}

function imageapi_optimize_pipeline_edit_add_new_processor_submit($form, &$form_state) {
  $form_state['rebuild'] = TRUE;
}

class ImageAPIOptimizePipeline {

}

/**
 * Export callback to load the view subrecords, which are the displays.
 */
function imageapi_optimize_load_processor_records(&$pipelines) {
  // Get vids from the views.
  $names = array();
  foreach ($pipelines as $pipeline) {
    if (empty($pipeline->processors)) {
      $names[$pipeline->pid] = $pipeline->machine_name;
    }
  }

  if (empty($names)) {
    return;
  }

  foreach (array('processor') as $key) {
    $object_name = "imageapi_optimize_pipeline_$key";
    $result = db_query("SELECT * FROM {{$object_name}} WHERE pid IN (:pids) ORDER BY pid, position",
      array(':pids' => array_keys($names)));

    foreach ($result as $data) {
      $object_class = imageapi_optimize_get_processor($data->processor);
      $object = new $object_class();

      $object->load_row($data);

      // Because it can get complicated with this much indirection,
      // make a shortcut reference.
      $location = &$pipelines[$names[$object->pid]]->$key;

      // If we have a basic id field, load the item onto the view based on
      // this ID, otherwise push it on.
      $location[] = $object;
    }
  }
}
